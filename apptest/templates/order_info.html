{% extends 'basely.html' %}
{% block base %}
    <div class="container">
		<div style="margin-bottom:10px">
				<!--实现方式1：通过bootstrap 添加属性data-toggle="modal" data-target="#myModal"-->
				<input type="button"   value="新建订单1" class="btn  btn-success" data-toggle="modal" data-target="#myModal">
				<!--实现方式2：通过属性id，写ajax：$('#myModal').modal(show);代码-->
				<input  type="button"   id="btnAdd" value="新建订单2" class="btn btn-success" >
        </div>

		<!--列表展示-->
		<div class="panel panel-default" >
              <!-- Default panel contents -->
              <div class="panel-heading">
                  <span class="glyphicon glyphicon-tn-list" aria-hidden="true">{{ title }}</span>
              </div>

              <!-- Table -->
              <table class="table table-bordered" >
                <thead>
                  <tr>
                      <th>ID</th>
                      <th>订单号</th>
                      <th>名称</th>
                      <th>价格</th>
                      <th>状态</th>
                      <th>管理员</th>
                      <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                {% for obj in queryset %}
                  <tr pkid="{{ obj.id }}">
                      <td>{{ obj.id }}</td>
                      <td>{{ obj.oid }}</td>
                      <td>{{ obj.title }}</td>
                      <td>{{ obj.price }}</td>
                      <td>{{ obj.get_status_display }}</td>
                      <td>{{ obj.admin.adminname }}</td>
                    <td>
                        <input oid="{{ obj.id }}" type="button" class="btn btn-primary btn-xs bt-edit" value="编辑" >
                        <input oid="{{ obj.id }}" type="button" class="btn btn-danger btn-xs btn-delete" value="删除" >
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
        </div>
                   <!--分页展示-->
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {{ page_string }}
            </ul>
        </nav>
    </div>
        <!-- 新建订单对话框-->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
		
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">新建订单</h4>
              </div>
              <div class="modal-body">
					<form id="formAdd" method="post"  novalidate>
						{% csrf_token %}
						{% for filed in form %}
						<div class="form-group">
							<label>{{ filed.label }}</label>
							{{ filed}}
							<span style="color:red">{{ filed.errors.0}}</span>
							{% endfor %}
							<!--<input type="text" class="form-control" placeholder="请输入部门名称" name="title"/>-->
						</div>
					</form>
              </div>
              <div class="modal-footer">
                <button id="btnComfirmdelete" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button id="btnSave"  type="button" class="btn btn-primary">保存</button>
              </div>
            </div>
          </div>
		</div>
    <!-- 新建删除订单对话框-->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
              <div class="alert alert-danger alert-dismissible fade in" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
                      <h4>是否确认删除</h4>
                      <p>删除后果自负，相关数据会被删除</p>
                      <p>
                        <button type="button" class="btn btn-danger">确定</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                      </p>
                </div>
          </div>
    </div>



{% endblock %}

{% block js %}
<script type="text/javascript">
    var DELETE_ID;
    var EDIT_ID;
     $(function(){
             <!--页面框架加载完成之后代码自动执行-->
             bindBtnaddEvent();
			 bindBtnSaveEvent();
			 bindBtnDeleteEvent();
             binbtnComfirmdeleteEvent();
             bindbtnEditEvent();

     })
     function bindBtnaddEvent(){
            $("#btnAdd").click(function (){
                    EDIT_ID = undefined
                    $("#formAdd")[0].reset();
                    $(".myModalLabel").text("新建订单");

		        <!--展示对话框-->
					$("#myModal").modal("show");
				});
				
		 }
	 function bindBtnSaveEvent(){
            $("#btnSave").click(function (){
					$(".err_msg").empty();

					if(EDIT_ID){
					<!--编辑-->
                         doEdit();
					}else{
					<!--添加-->
                         doAdd();
					}
			})
	 }

    function doEdit(){
            $.ajax({
					url:"/order_info/edit/" + "?pkid=" + EDIT_ID,
					type:"post",
					data:$("#formAdd").serialize(),
					dataType:"JSON",
					success:function(res){
					    console.log(res);
						if (res.status){
								alert("创建成功");
								<!--"#formAdd"为jQuery对象，("#为jQuery对象formAdd")[0]将其转换为DOM对象-->
								$("#formAdd")[0].reset();
								$("#myModal").modal("hide");
								location.reload();
						} else {
						        if(res.tips){
		    						alert(res.tips);
						        }else{
						            $.each(res.error,function(name,errorlist){
									    $("#id_" + name).next().text(errorlist[0]);
								    });
						        }

						}
					}
			});

    }

	 function doAdd(){
	        $.ajax({
					url:"/order_info/add/",
					type:"post",
					data:$("#formAdd").serialize(),
					dataType:"JSON",
					success:function(res){
					    console.log(res);
						if (res.status){
								alert("创建成功");
								<!--"#formAdd"为jQuery对象，("#为jQuery对象formAdd")[0]将其转换为DOM对象-->
								$("#formAdd")[0].reset();
								$("#myModal").modal("hide");
								location.reload();
						} else {
								alert("创建失败");
								$.each(res.error,function(name,errorlist){
									$("#id_" + name).next().text(errorlist[0]);
								});
						}
					}
			});
	 }



     function bindBtnDeleteEvent(){
        $(".btn-delete").click(function (){
                $("#deleteModal").modal("show");
                <!--获取当前id并赋值给全局变量-->
                DELETE_ID = $(this).attr("oid");
        });
     }

     function binbtnComfirmdeleteEvent(){
        $("#btnComfirmdelete").click(function (){
            $.ajax({
                url:"/order_info/" + DELETE_ID + "/delete/",
                type:"GET",
                data:{
                    pkid:DELETE_ID
                }
                dataType:"JSON",
                success:function (res){
                    if (res.status){

                       <!--方式1：info页面删除记录 通过js实现,会出现分页数据未同步-->
                        <!--$("#deleteModal").modal("hide");-->
                        <!--$("tr[pkid='" + DELETE_ID + "']").remove();-->
                        <!--DELETE_ID = 0;-->
                        <!--方式2：info页面删除记录 通过刷新页面实现-->
                            location.reload();
                    }else {
                        alert("删除失败");
                    }
                }

            })
        });
     }

     function bindbtnEditEvent(){
        $(".bt-edit").click(function (){
            $("#formAdd")[0].reset();
            EDIT_ID = $(this).attr("oid");
            $.ajax({
                url:"/order_info/detail"
                type:"GET",
                data:{
                    pkid:EDIT_ID,
                }
                dataType:"JSON",
                success:function (res){
                    if (res.status){
                    `````$.each(res.data,function(name,value){
                                $("#id_" + name).val(value)
                          });
                         $(".myModalLabel").text("编辑订单");
                         $("#myModal").modal("show");

                    }else {
                        alert("编辑失败")

                    }
                }
            })
        });

     }

</script>
{% endblock %}
